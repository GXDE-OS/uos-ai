import{a7 as e,f as a,h as l,j as t,S as u,L as s,b as o,u as n,r as v,p as i,w as r,c,x as d,P as p,H as g,I as y,J as m,a8 as h,a as w,T as S,ab as C,ac as A,a9 as f}from"./index.js";import{u as T,Q as b}from"./global.js";import{_ as k,a as R}from"./ChatTop.js";const P=""+new URL("silence.webm",import.meta.url).href,L=""+new URL("listen2.png",import.meta.url).href,I=""+new URL("listen1.png",import.meta.url).href,V=""+new URL("listen.webm",import.meta.url).href,q=""+new URL("thinking.webm",import.meta.url).href,x=""+new URL("play.webm",import.meta.url).href,D=""+new URL("error.webm",import.meta.url).href,E=["tip"],O={class:"tips-con"},M=e({__name:"tips",props:{tip:{type:String,required:!0},className:{type:Boolean}},setup:e=>(o,n)=>(a(),l("div",{class:s(["uos-tips",e.className]),tip:e.tip},[t("div",O,u(e.tip),1)],10,E))},[["__scopeId","data-v-9d6ce8a8"]]),N=e=>(C("data-v-fc6acd64"),e=e(),A(),e),U={class:"",style:{position:"relative",flex:"1 1 0"}},_={class:"logo"},B=["src"],J=[N((()=>t("source",{src:P,type:"video/webm"},null,-1)))],j={class:"listen"},F=[N((()=>t("div",{class:"scale"},[t("img",{src:L,class:"listen-img rotate"})],-1))),N((()=>t("div",{class:"scale1"},[t("img",{src:I,class:"listen-img rotate"})],-1)))],W=[N((()=>t("source",{src:V,type:"video/webm"},null,-1)))],Q=[N((()=>t("source",{src:q,type:"video/webm"},null,-1)))],H=[N((()=>t("source",{src:x,type:"video/webm"},null,-1)))],z=[N((()=>t("source",{src:D,type:"video/webm"},null,-1)))],G={class:"active-box"},K={class:"active-con"},X={key:0,ref:"target"},Y={key:1},Z={class:"dian"},$={key:0,class:"fz-14"},ee={class:"svgBg"},ae=N((()=>t("div",{class:"svgBg-hover"},null,-1))),le={class:"svgBg"},te=N((()=>t("div",{class:"svgBg-hover"},null,-1))),ue=e({__name:"DigitalImage",setup(e){const{chatQWeb:C,updateActivityColor:A,updateTheme:P,updateFont:L}=T(),I=T();o();const V=n(),q=v(1),x=v(1),D=v(2),E=v(!1),O=v(""),N=v(!1),ue=v(!1),se=v(""),oe=v(!1),ne=v(!1),ve=v(2),ie=i((()=>2==D.value||3==D.value||4==D.value||7==D.value?T().loadTranslations.Stop:T().loadTranslations.Activate)),re=v("top-right"),ce=i((()=>{switch(D.value){case 1:return[T().loadTranslations.Sleeping,T().loadTranslations["Click on the animation or Ctrl+Super+C to activate"]];case 2:default:return[T().loadTranslations.Listening,T().loadTranslations["Click the animation or press Enter to send"]];case 3:return[T().loadTranslations.Thinking,T().loadTranslations["Click animation to interrupt"]];case 4:return[T().loadTranslations.Answering,T().loadTranslations["Click animation to interrupt"]];case 5:return T().loadTranslations["Unable to connect to the server, please check your network or try again later."];case 6:return T().loadTranslations["Microphone not detected"];case 7:return T().loadTranslations["Stop recording after %1 seconds"].replace("%1",Re.value);case 8:case 9:return me.value;case 10:return T().loadTranslations["Sound output device not detected"]}})),de=v([]),pe=v([]),ge=v(""),ye=v(""),me=v(""),he=v(!1),we=v(!1);let Se=null;const Ce=()=>{Se&&clearTimeout(Se),Se=setTimeout((()=>{we.value=!0}),2e3)},Ae=()=>{Se&&clearTimeout(Se),we.value=!1};let fe=0,Te=null;const be=()=>{console.log("startCounter-------"),Te=setInterval((()=>{fe++,console.log("startCounter",fe,O.value.trim().length),2==fe&&0!==O.value.trim().length?(console.log("5count","startCounter",fe),Ee()):10==fe&&(console.log("10count",fe),Ee(),D.value=1,b(C.updateVoiceConversationStatus,D.value))}),1e3)},ke=()=>{console.log("stopCounter------"),Te&&(clearInterval(Te),Te=null,fe=0)},Re=v(0),Pe=v(!1),Le=async()=>{if(console.log(999,"handleRecorder",Pe.value,he.value,N.value),N.value&&!he.value)return Pe.value?Ee():void(Pe.value||(N.value=await b(C.isAudioInputAvailable),await b(C.stopPlayTextAudio),N.value&&(console.log("startRecorder-------"),await b(C.startRecorder,1),Pe.value=!0,se.value="")))},Ie=v(""),Ve=async()=>{if(console.log("sendQuestion",O.value),0===O.value.trim().length||ne.value)return void(O.value="");await b(C.stopPlayTextAudio),se.value="",Pe.value&&Ee(),ke(),de.value.push({role:"user",content:O.value});const{id:e,model:a,icon:l,llmname:t}=ge.value,u=await b(C.sendAiRequest,e||"",a||"",1,O.value,2);de.value.push({role:"assistant",anwsers:[{content:"",talkID:u,status:0,type:0,llmIcon:l,llmName:t}]}),Ie.value=u,he.value=!0,O.value="",6!==D.value&&10!==D.value&&(D.value=3,b(C.updateVoiceConversationStatus,D.value))},qe=e=>{if(!E.value){if(console.log("activeFun",D.value,e),2==D.value||7==D.value){if(e&&0!==O.value.trim().length)return void Ee();Ee(),D.value=1}else 3==D.value?(Me(),D.value=1):4==D.value?(D.value=1,De()):1!=D.value&&9!=D.value||(D.value=2,Pe.value=!1);b(C.updateVoiceConversationStatus,D.value)}},xe=async e=>{const{content:a,talkID:l}=k.last(de.value).anwsers[0];await b(C.playTextAudio,l,e||a,!0),se.value=l},De=async()=>{await b(C.stopPlayTextAudio),se.value=""},Ee=async(e,a)=>{console.log("sigAudioASRError",e,a),Pe.value=!1,await b(C.stopRecorder),e&&oe.value&&V.push("/chat"),e&&6!==D.value&&(D.value=9,b(C.updateVoiceConversationStatus,D.value),me.value=a)},Oe=e=>{console.log("sigPlayTTSFinished",e),se.value===e&&(se.value=""),5!==D.value&&6!==D.value&&8!==D.value&&9!==D.value&&(D.value=1,b(C.updateVoiceConversationStatus,D.value)),he.value=!1},Me=async()=>{await b(C.cancelAiRequest,Ie.value);const e=de.value[de.value.length-2].content,{type:a,content:l}=k.last(k.last(de.value).anwsers),{icon:t,displayname:u}=ge.value;b(C.logAiChatRecord,Ie.value,e,l,!1,0,"",a,t||"",u||""),he.value=!1,ke()};r((()=>D.value),(e=>{ve.value=e,console.log("watch",e),1==e?(C&&C.playSystemSound&&b(C.playSystemSound,1),De(),ke(),he.value=!1):2==e?(C&&C.playSystemSound&&b(C.playSystemSound,0),he.value=!1,Pe.value=!1,Le(),be()):ke(),4==e&&ne.value&&De(),5==e||6==e||8==e||10==e?(document.querySelector(".video5")&&(document.querySelector(".video5").currentTime=0,document.querySelector(".video5").play()),E.value=!0):9==e?(document.querySelector(".video5")&&(document.querySelector(".video5").currentTime=0,document.querySelector(".video5").play()),E.value=!1):(document.querySelector(".video5")&&document.querySelector(".video5").pause(),E.value=!1)}),{deep:!0,immediate:!1});const Ne={sigAiReplyStream:(e,a,l)=>{if(console.log({type:e,value:a,status:l}),0===l?k.last(k.last(de.value).anwsers).content=k.last(k.last(de.value).anwsers).content+a:200===l?(k.last(k.last(de.value).anwsers).status=l,xe(),6!==D.value&&10!==D.value&&(D.value=4)):(k.last(k.last(de.value).anwsers).content=a,k.last(de.value).status=l,k.last(k.last(de.value).anwsers).status=l),0!==l){const e=de.value[de.value.length-2].content,{type:a,content:t}=k.last(k.last(de.value).anwsers);l<0&&(-9002===l||-9e3===l||-9001===l||-9003===l||-9004===l?(me.value=t,D.value=8):D.value=4,xe());const{icon:u,displayname:s}=ge.value;b(C.logAiChatRecord,Ie.value,e,t,!1,l,"",a,u||"",s||"")}b(C.updateVoiceConversationStatus,D.value)},sigAudioASRStream:(e,a)=>{console.log("sigAudioASRStream",e,a),O.value=e,""!==e&&(ke(),2==D.value&&be()),a&&oe.value?(ke(),V.push("/chat")):a&&1!==D.value&&10!==D.value&&Ve()},sigAudioASRError:Ee,sigAudioCountDown:e=>{Re.value=e,Re.value>0?(D.value=7,b(C.updateVoiceConversationStatus,D.value)):Ee()},sigPlayTTSFinished:Oe,sigPlayTTSError:e=>se.value="",sigActiveColorChanged:e=>A(e),sigAudioInputDevChange:e=>{console.log("sigAudioInputDevChange"),N.value=e,e||(Pe.value=!1),e?ue.value?D.value=1:D.value=10:D.value=6,b(C.updateVoiceConversationStatus,D.value)},sigAudioSampleLevel:e=>{const a=1+e/100*.7,l=1+e/100*1.2;q.value=a,x.value=l},sigNetStateChanged:e=>{e?D.value=1:(2==D.value&&Ee(),3==D.value&&Me(),4==D.value&&De(),D.value=5),b(C.updateVoiceConversationStatus,D.value)},sigText2PicFinish:(e,a)=>{k.last(k.last(de.value).anwsers).content=JSON.stringify(a);const l=de.value[de.value.length-2].content,t=k.last(k.last(de.value).anwsers).type,u=k.last(k.last(de.value).anwsers).status;console.log(Ie.value,l,a,0,"",t,u);const{icon:s,displayname:o}=ge.value;b(C.logAiChatRecord,Ie.value,l,JSON.stringify(a),!1,0,"",t,s||"",o||""),he.value=!1,u>=0&&2===t&&a&&(xe(T().loadTranslations["The picture has been generated, please switch to the chat interface to view it."]),6!==D.value&&10!==D.value&&(D.value=4,b(C.updateVoiceConversationStatus,D.value)))},sigChatConversationType:(e,a)=>{void 0!==k.last(de.value)&&(k.last(k.last(de.value).anwsers).type=a)},sigWebchat2BeHiden:()=>{ne.value=!0,2==D.value&&(Ee(),D.value=1,b(C.updateVoiceConversationStatus,D.value)),4==D.value&&De()},sigWebchat2BeShowed:async()=>{ne.value=!1,1==D.value&&(D.value=2),4==D.value&&(Oe(),D.value=2),b(C.updateVoiceConversationStatus,D.value)},sigThemeChanged:e=>{P(e)},sigFontChanged:(e,a)=>{L(e,a)},llmAccountLstChanged:(e,a)=>{console.log(6555,e,a);const l=JSON.parse(a),t=l.findIndex((e=>e.id===ge.value.id));e!==ge.value.id&&0!==l.length&&5!==D.value&&6!==D.value&&(D.value=1,b(C.updateVoiceConversationStatus,D.value)),e||(ge.value={}),t>-1?(l[t].active=!0,ge.value=l[t]):l.forEach((a=>{a.id===e&&(a.active=!0,ge.value=a)})),pe.value=l},sigDigitalModeActive:()=>{1==D.value&&(D.value=2,b(C.updateVoiceConversationStatus,D.value))},sigChatModeActive:()=>{(()=>{if(2==D.value)oe.value=!0,0===O.value.trim().length?(Pe.value=!1,b(C.stopRecorder),ke(),V.push("/chat")):Ee();else{if(3==D.value||4==D.value)return;ke(),V.push("/chat")}})()},sigAudioOutputDevChanged:async e=>{ue.value=e,e?N.value?D.value=1:D.value=6:(se.value="",2==D.value||7==D.value?await b(C.stopRecorder):3==D.value?Me():4==D.value&&De(),D.value=10),b(C.updateVoiceConversationStatus,D.value)},sigWebchatModalityChanged:e=>(e=>{let a=document.querySelector("#drop-mask");a||(a=document.createElement("div"),a.id="drop-mask",document.body.appendChild(a)),a.style.height="100vh",a.style.width="100vw",a.style.display=e?"flex":"none"})(e)};function Ue(e){"Enter"===e.key&&(e.stopPropagation(),e.preventDefault(),console.log("handleEnterKey",O.value),0!==O.value.trim().length&&Ee())}return c((async()=>{for(const e in Ne)Object.hasOwnProperty.call(Ne,e)&&C[e].connect(Ne[e]);document.addEventListener("keydown",Ue),(async()=>{const e=await b(C.getAiChatRecords,!1),a=await b(C.queryLLMAccountList),l=await b(C.currentLLMAccountId),t=await b(C.queryAssistantList),u=await b(C.currentAssistantId);N.value=await b(C.isAudioInputAvailable),ue.value=await b(C.isAudioOutputAvailable),de.value=JSON.parse(e);const s=await b(C.isNetworkAvailable);t&&JSON.parse(t).forEach((e=>{e.id===u&&(e.active=!0,ye.value=e)}));if(a){const e=JSON.parse(a);e.forEach((e=>{e.id===l&&(e.active=!0,ge.value=e)})),pe.value=e}s?(N.value?ue.value?(C.playSystemSound&&b(C.playSystemSound,0),Le(),be()):D.value=10:D.value=6,b(C.updateVoiceConversationStatus,D.value)):D.value=5})(),T().loadTranslations=await b(C.loadTranslations)})),d((()=>{for(const e in Ne)Object.hasOwnProperty.call(Ne,e)&&C[e].disconnect(Ne[e]);document.removeEventListener("keydown",Ue)})),(e,o)=>{const n=f;return a(),l("div",{class:"main-content",style:S({"--scale":q.value,"--scale1":x.value})},[p(R),t("div",U,[t("div",_,[t("img",{src:ye.value.iconPrefix+ye.value.icon+"-110.svg",class:""},null,8,B),t("div",null,u(ye.value.displayname),1)]),t("div",{class:s(["animate-box",{disabledDig:E.value}]),onClick:o[10]||(o[10]=e=>qe(!0))},[ne.value?m("",!0):g((a(),l("video",{key:0,class:"video1",autoplay:"",loop:"",muted:"",onPlay:o[0]||(o[0]=e=>1==ve.value&&!ne.value),onPause:o[1]||(o[1]=e=>1!==ve.value||ne.value)},J,544)),[[y,1==D.value]]),g(t("div",j,F,512),[[y,2==D.value||7==D.value]]),ne.value?m("",!0):g((a(),l("video",{key:1,class:"video2",autoplay:"",loop:"",muted:"",onPlay:o[2]||(o[2]=e=>!ne.value&&(2==ve.value||7==ve.value)),onPause:o[3]||(o[3]=e=>2!==ve.value&&7!==ve.value||ne.value)},W,544)),[[y,2==D.value||7==D.value]]),ne.value?m("",!0):g((a(),l("video",{key:2,class:"video3",autoplay:"",loop:"",muted:"",onPlay:o[4]||(o[4]=e=>3==ve.value&&!ne.value),onPause:o[5]||(o[5]=e=>3!==ve.value||ne.value)},Q,544)),[[y,3==D.value]]),ne.value?m("",!0):g((a(),l("video",{key:3,class:"video4",autoplay:"",loop:"",muted:"",onPlay:o[6]||(o[6]=e=>4==ve.value&&!ne.value),onPause:o[7]||(o[7]=e=>4!==ve.value||ne.value)},H,544)),[[y,4==D.value]]),ne.value?m("",!0):g((a(),l("video",{key:4,class:"video5",autoplay:"",muted:"",onPlay:o[8]||(o[8]=e=>!ne.value&&(5==ve.value||6==ve.value||8==ve.value||9==ve.value||10==ve.value)),onPause:o[9]||(o[9]=e=>5!==ve.value&&6!==ve.value&&8!==ve.value&&9!==ve.value&&10!==ve.value||ne.value)},z,544)),[[y,5==D.value||6==D.value||8==D.value||9==D.value||10==D.value]])],2)]),t("div",G,[t("div",K,[8==D.value?(a(),l("pre",X,[h(u(w(ce)),1),t("span",{class:"go-config",href:"#",onClick:o[11]||(o[11]=e=>w(b)(w(C).launchLLMConfigWindow,!0))}," "+u(w(I).loadTranslations["Go to configuration"])+" >",1)],512)):(a(),l("div",Y,[g(p(n,{icon:"voice"},null,512),[[y,2==D.value]]),h(u(Array.isArray(w(ce))?w(ce)[0]:w(ce))+" ",1),g(t("span",Z,"...",512),[[y,1==D.value||2==D.value||3==D.value||4==D.value]]),Array.isArray(w(ce))?(a(),l("div",$,u(w(ce)[1]),1)):m("",!0)]))]),2==D.value||3==D.value||4==D.value||7==D.value?(a(),l("div",{key:0,class:s(["handel",{disabledDig:E.value}]),onMouseenter:o[12]||(o[12]=e=>Ce()),onMouseleave:o[13]||(o[13]=e=>Ae()),onClick:o[14]||(o[14]=e=>qe())},[t("div",ee,[p(n,{icon:"dig-stop"})]),ae,g(p(M,{tip:w(ie),class:s(re.value)},null,8,["tip","class"]),[[y,we.value]])],34)):(a(),l("div",{key:1,class:s(["handel",{disabledDig:E.value}]),onClick:o[15]||(o[15]=e=>qe()),onMouseenter:o[16]||(o[16]=e=>Ce()),onMouseleave:o[17]||(o[17]=e=>Ae())},[t("div",le,[p(n,{icon:"dig-play"})]),te,g(p(M,{tip:w(ie),class:s(re.value)},null,8,["tip","class"]),[[y,we.value]])],34))])],4)}}},[["__scopeId","data-v-fc6acd64"]]);export{ue as default};
